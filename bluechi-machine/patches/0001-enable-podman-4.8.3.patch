From ca429ef63da0d0d54519987b8849075eb06ce1e1 Mon Sep 17 00:00:00 2001
From: Leonardo Rossetti <lrossett@redhat.com>
Date: Thu, 14 Nov 2024 12:57:20 -0300
Subject: [PATCH] enable podman 4.8.3

Signed-off-by: Leonardo Rossetti <lrossett@redhat.com>
---
 recipes-containers/podman/podman_git.bb | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/recipes-containers/podman/podman_git.bb b/recipes-containers/podman/podman_git.bb
index 09bf8270..c5528020 100644
--- a/recipes-containers/podman/podman_git.bb
+++ b/recipes-containers/podman/podman_git.bb
@@ -11,18 +11,14 @@ REQUIRED_DISTRO_FEATURES ?= "seccomp ipv6"
 
 DEPENDS = " \
     go-metalinter-native \
-    go-md2man-native \
     gpgme \
     libseccomp \
     ${@bb.utils.filter('DISTRO_FEATURES', 'systemd', d)} \
 "
 
-SRCREV = "717edd7b844dcd66468f5d991991d87e9fc14c12"
+SRCREV = "85dc30df56566a654700722a4dd190e1b9680ee7"
 SRC_URI = " \
-    git://github.com/containers/libpod.git;branch=v4.0;protocol=https \
-    file://0001-Rename-BUILDFLAGS-to-GOBUILDFLAGS.patch;patchdir=src/import \
-    file://0002-Define-ActKillThread-equal-to-ActKill.patch;patchdir=src/import/vendor/github.com/seccomp/libseccomp-golang \
-    file://CVE-2022-27649.patch;patchdir=src/import \
+    git://github.com/containers/libpod.git;branch=v4.8;protocol=https \
     ${@bb.utils.contains('PACKAGECONFIG', 'rootless', 'file://50-podman-rootless.conf', '', d)} \
 "
 
@@ -33,7 +29,7 @@ GO_IMPORT = "import"
 
 S = "${WORKDIR}/git"
 
-PV = "4.0.1+git${SRCPV}"
+PV = "4.8.3+git${SRCPV}"
 
 PACKAGES =+ "${PN}-contrib"
 
@@ -85,7 +81,11 @@ do_compile() {
 	export CGO_CFLAGS="${CFLAGS} --sysroot=${STAGING_DIR_TARGET}"
 	export CGO_LDFLAGS="${LDFLAGS} --sysroot=${STAGING_DIR_TARGET}"
 
-	oe_runmake BUILDTAGS="${BUILDTAGS}"
+	# oe_runmake BUILDTAGS="${BUILDTAGS}"
+    export NATIVE_GOOS=${BUILD_GOOS} 
+    export NATIVE_GOARCH=${BUILD_GOARCH}
+    export GOFLAGS="-mod=vendor" 
+    oe_runmake NATIVE_GOOS=${BUILD_GOOS} NATIVE_GOARCH=${BUILD_GOARCH} BUILDTAGS="${BUILDTAGS}"
 }
 
 do_install() {
@@ -112,8 +112,10 @@ do_install() {
 
 FILES:${PN} += " \
     ${systemd_unitdir}/system/* \
+    ${nonarch_libdir}/systemd/* \
     ${systemd_unitdir}/user/* \
     ${nonarch_libdir}/tmpfiles.d/* \
+    ${datadir}/user-tmpfiles.d/* \
     ${sysconfdir}/cni \
 "
 
-- 
2.47.0

