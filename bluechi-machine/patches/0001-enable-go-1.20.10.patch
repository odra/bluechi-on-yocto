From a3b309ac27684f00189d7b52d63b73ea1904ff92 Mon Sep 17 00:00:00 2001
From: Leonardo Rossetti <lrossett@redhat.com>
Date: Thu, 14 Nov 2024 10:49:59 -0300
Subject: [PATCH] enable go 1.20.10

Signed-off-by: Leonardo Rossetti <lrossett@redhat.com>
---
 meta/recipes-devtools/go/go-1.17.13.inc       | 70 -------------------
 meta/recipes-devtools/go/go-1.20.10.inc       | 63 +++++++++++++++++
 ...1.17.13.bb => go-binary-native_1.20.10.bb} | 11 +--
 meta/recipes-devtools/go/go-common.inc        |  2 +-
 ....17.13.bb => go-cross-canadian_1.20.10.bb} |  0
 ...o-cross_1.17.13.bb => go-cross_1.20.10.bb} |  0
 ...ssdk_1.17.13.bb => go-crosssdk_1.20.10.bb} |  0
 ...native_1.17.13.bb => go-native_1.20.10.bb} |  0
 ...ntime_1.17.13.bb => go-runtime_1.20.10.bb} |  1 -
 .../go/{go_1.17.13.bb => go_1.20.10.bb}       |  3 +-
 10 files changed, 71 insertions(+), 79 deletions(-)
 delete mode 100644 meta/recipes-devtools/go/go-1.17.13.inc
 create mode 100644 meta/recipes-devtools/go/go-1.20.10.inc
 rename meta/recipes-devtools/go/{go-binary-native_1.17.13.bb => go-binary-native_1.20.10.bb} (64%)
 rename meta/recipes-devtools/go/{go-cross-canadian_1.17.13.bb => go-cross-canadian_1.20.10.bb} (100%)
 rename meta/recipes-devtools/go/{go-cross_1.17.13.bb => go-cross_1.20.10.bb} (100%)
 rename meta/recipes-devtools/go/{go-crosssdk_1.17.13.bb => go-crosssdk_1.20.10.bb} (100%)
 rename meta/recipes-devtools/go/{go-native_1.17.13.bb => go-native_1.20.10.bb} (100%)
 rename meta/recipes-devtools/go/{go-runtime_1.17.13.bb => go-runtime_1.20.10.bb} (97%)
 rename meta/recipes-devtools/go/{go_1.17.13.bb => go_1.20.10.bb} (91%)

diff --git a/meta/recipes-devtools/go/go-1.17.13.inc b/meta/recipes-devtools/go/go-1.17.13.inc
deleted file mode 100644
index 349b0be6be..0000000000
--- a/meta/recipes-devtools/go/go-1.17.13.inc
+++ /dev/null
@@ -1,70 +0,0 @@
-require go-common.inc
-
-FILESEXTRAPATHS:prepend := "${FILE_DIRNAME}/go-1.21:${FILE_DIRNAME}/go-1.20:${FILE_DIRNAME}/go-1.19:${FILE_DIRNAME}/go-1.18:"
-
-LIC_FILES_CHKSUM = "file://LICENSE;md5=5d4950ecb7b26d2c5e4e7b4e0dd74707"
-
-SRC_URI += "\
-    file://0001-allow-CC-and-CXX-to-have-multiple-words.patch \
-    file://0002-cmd-go-make-content-based-hash-generation-less-pedan.patch \
-    file://0003-allow-GOTOOLDIR-to-be-overridden-in-the-environment.patch \
-    file://0004-ld-add-soname-to-shareable-objects.patch \
-    file://0005-make.bash-override-CC-when-building-dist-and-go_boot.patch \
-    file://0006-cmd-dist-separate-host-and-target-builds.patch \
-    file://0007-cmd-go-make-GOROOT-precious-by-default.patch \
-    file://0008-use-GOBUILDMODE-to-set-buildmode.patch \
-    file://0009-Revert-cmd-go-make-sure-CC-and-CXX-are-absolute.patch \
-    file://0001-exec.go-do-not-write-linker-flags-into-buildids.patch \
-    file://0001-src-cmd-dist-buildgo.go-do-not-hardcode-host-compile.patch \
-    file://0010-net-Fix-issue-with-DNS-not-being-updated.patch  \
-    file://CVE-2022-27664.patch \
-    file://0001-net-http-httputil-avoid-query-parameter-smuggling.patch \
-    file://CVE-2022-41715.patch \
-    file://CVE-2022-41717.patch \
-    file://CVE-2022-2879.patch \
-    file://CVE-2022-41720.patch \
-    file://CVE-2022-41723.patch \
-    file://cve-2022-41724.patch \
-    file://add_godebug.patch \
-    file://cve-2022-41725.patch \
-    file://CVE-2022-41722.patch \
-    file://CVE-2023-24537.patch \
-    file://CVE-2023-24534.patch \
-    file://CVE-2023-24538_1.patch \
-    file://CVE-2023-24538_2.patch \
-    file://CVE-2023-24540.patch \
-    file://CVE-2023-24539.patch \
-    file://CVE-2023-29404.patch \
-    file://CVE-2023-29405.patch \
-    file://CVE-2023-29402.patch \
-    file://CVE-2023-29400.patch \
-    file://CVE-2023-29406-1.patch \
-    file://CVE-2023-29406-2.patch \
-    file://CVE-2023-24536_1.patch \
-    file://CVE-2023-24536_2.patch \
-    file://CVE-2023-24536_3.patch \
-    file://CVE-2023-24531_1.patch \
-    file://CVE-2023-24531_2.patch \
-    file://CVE-2023-29409.patch \
-    file://CVE-2023-39319.patch \
-    file://CVE-2023-39318.patch \
-    file://CVE-2023-39326.patch \
-    file://CVE-2023-45285.patch \
-    file://CVE-2023-45287.patch \
-    file://CVE-2023-45289.patch \
-    file://CVE-2023-45290.patch \
-    file://CVE-2024-24784.patch \
-    file://CVE-2024-24785.patch \
-    file://CVE-2023-45288.patch \
-    file://CVE-2024-24789.patch \
-    file://CVE-2024-24791.patch \
-"
-SRC_URI[main.sha256sum] = "a1a48b23afb206f95e7bbaa9b898d965f90826f6f1d1fc0c1d784ada0cd300fd"
-
-# Upstream don't believe it is a signifiant real world issue and will only
-# fix in 1.17 onwards where we can drop this.
-# https://github.com/golang/go/issues/30999#issuecomment-910470358
-CVE_CHECK_IGNORE += "CVE-2021-29923"
-
-# This are specific to Microsoft Windows
-CVE_CHECK_IGNORE += "CVE-2022-41716 CVE-2023-45283 CVE-2023-45284"
diff --git a/meta/recipes-devtools/go/go-1.20.10.inc b/meta/recipes-devtools/go/go-1.20.10.inc
new file mode 100644
index 0000000000..fcc4d46300
--- /dev/null
+++ b/meta/recipes-devtools/go/go-1.20.10.inc
@@ -0,0 +1,63 @@
+require go-common.inc
+
+# FILESEXTRAPATHS:prepend := "${FILE_DIRNAME}/go-1.20:${FILE_DIRNAME}/go-1.19:${FILE_DIRNAME}/go-1.18:"
+
+# LIC_FILES_CHKSUM = "file://LICENSE;md5=b97a012949927931feb7793eee5ed924"
+LIC_FILES_CHKSUM = "file://LICENSE;md5=5d4950ecb7b26d2c5e4e7b4e0dd74707" 
+# SRC_URI += "\
+#     file://0001-allow-CC-and-CXX-to-have-multiple-words.patch \
+#     file://0002-cmd-go-make-content-based-hash-generation-less-pedan.patch \
+#     file://0003-allow-GOTOOLDIR-to-be-overridden-in-the-environment.patch \
+#     file://0004-ld-add-soname-to-shareable-objects.patch \
+#     file://0005-make.bash-override-CC-when-building-dist-and-go_boot.patch \
+#     file://0006-cmd-dist-separate-host-and-target-builds.patch \
+#     file://0007-cmd-go-make-GOROOT-precious-by-default.patch \
+#     file://0008-use-GOBUILDMODE-to-set-buildmode.patch \
+#     file://0009-Revert-cmd-go-make-sure-CC-and-CXX-are-absolute.patch \
+#     file://0001-exec.go-do-not-write-linker-flags-into-buildids.patch \
+#     file://0001-src-cmd-dist-buildgo.go-do-not-hardcode-host-compile.patch \
+#     file://0010-net-Fix-issue-with-DNS-not-being-updated.patch  \
+#     file://CVE-2022-27664.patch \
+#     file://0001-net-http-httputil-avoid-query-parameter-smuggling.patch \
+#     file://CVE-2022-41715.patch \
+#     file://CVE-2022-41717.patch \
+#     file://CVE-2022-2879.patch \
+#     file://CVE-2022-41720.patch \
+#     file://CVE-2022-41723.patch \
+#     file://cve-2022-41724.patch \
+#     file://add_godebug.patch \
+#     file://cve-2022-41725.patch \
+#     file://CVE-2022-41722.patch \
+#     file://CVE-2023-24537.patch \
+#     file://CVE-2023-24534.patch \
+#     file://CVE-2023-24538_1.patch \
+#     file://CVE-2023-24538_2.patch \
+#     file://CVE-2023-24540.patch \
+#     file://CVE-2023-24539.patch \
+#     file://CVE-2023-29404.patch \
+#     file://CVE-2023-29405.patch \
+#     file://CVE-2023-29402.patch \
+#     file://CVE-2023-29400.patch \
+#     file://CVE-2023-29406-1.patch \
+#     file://CVE-2023-29406-2.patch \
+#     file://CVE-2023-24536_1.patch \
+#     file://CVE-2023-24536_2.patch \
+#     file://CVE-2023-24536_3.patch \
+#     file://CVE-2023-29409.patch \
+#     file://CVE-2023-39319.patch \
+#     file://CVE-2023-39326.patch \
+#     file://CVE-2023-45285.patch \
+#     file://CVE-2023-45287.patch \
+#     file://CVE-2024-24784.patch \
+#     file://CVE-2024-24785.patch \
+#     file://CVE-2023-45288.patch \
+# "
+SRC_URI[main.sha256sum] = "72d2f51805c47150066c103754c75fddb2c19d48c9219fa33d1e46696c841dbb"
+
+# Upstream don't believe it is a signifiant real world issue and will only
+# fix in 1.17 onwards where we can drop this.
+# https://github.com/golang/go/issues/30999#issuecomment-910470358
+# CVE_CHECK_IGNORE += "CVE-2021-29923"
+
+# This are specific to Microsoft Windows
+# CVE_CHECK_IGNORE += "CVE-2022-41716 CVE-2023-45283 CVE-2023-45284"
diff --git a/meta/recipes-devtools/go/go-binary-native_1.17.13.bb b/meta/recipes-devtools/go/go-binary-native_1.20.10.bb
similarity index 64%
rename from meta/recipes-devtools/go/go-binary-native_1.17.13.bb
rename to meta/recipes-devtools/go/go-binary-native_1.20.10.bb
index 4ee0148417..280ad6402c 100644
--- a/meta/recipes-devtools/go/go-binary-native_1.17.13.bb
+++ b/meta/recipes-devtools/go/go-binary-native_1.20.10.bb
@@ -1,17 +1,18 @@
 # This recipe is for bootstrapping our go-cross from a prebuilt binary of Go from golang.org.
 
 SUMMARY = "Go programming language compiler (upstream binary for bootstrap)"
-HOMEPAGE = " http://golang.org/"
+HOMEPAGE = " https://go.dev/"
 LICENSE = "BSD-3-Clause"
 LIC_FILES_CHKSUM = "file://LICENSE;md5=5d4950ecb7b26d2c5e4e7b4e0dd74707"
 
 PROVIDES = "go-native"
 
-SRC_URI = "https://dl.google.com/go/go${PV}.${BUILD_GOOS}-${BUILD_GOARCH}.tar.gz;name=go_${BUILD_GOTUPLE}"
-SRC_URI[go_linux_amd64.sha256sum] = "4cdd2bc664724dc7db94ad51b503512c5ae7220951cac568120f64f8e94399fc"
-SRC_URI[go_linux_arm64.sha256sum] = "914daad3f011cc2014dea799bb7490442677e4ad6de0b2ac3ded6cee7e3f493d"
+# SRC_URI = "https://dl.google.com/go/go${PV}.${BUILD_GOOS}-${BUILD_GOARCH}.tar.gz;name=go_${BUILD_GOTUPLE}"
+SRC_URI = "https://go.dev/go/go${PV}.${BUILD_GOOS}-${BUILD_GOARCH}.tar.gz;name=go_${BUILD_GOTUPLE}"
+SRC_URI[go_linux_amd64.sha256sum] = "80d34f1fd74e382d86c2d6102e0e60d4318461a7c2f457ec1efc4042752d4248"
+SRC_URI[go_linux_arm64.sha256sum] = "fb3c7e15fc4413c5b81eb9f26dbd7cd4faedd5c720b30fa8e2ff77457f74cab6"
 
-UPSTREAM_CHECK_URI = "https://golang.org/dl/"
+UPSTREAM_CHECK_URI = "https://go.dev/dl/"
 UPSTREAM_CHECK_REGEX = "go(?P<pver>\d+(\.\d+)+)\.linux"
 
 S = "${WORKDIR}/go"
diff --git a/meta/recipes-devtools/go/go-common.inc b/meta/recipes-devtools/go/go-common.inc
index 83f8db7b39..8d1d4bb0b1 100644
--- a/meta/recipes-devtools/go/go-common.inc
+++ b/meta/recipes-devtools/go/go-common.inc
@@ -14,7 +14,7 @@ LICENSE = "BSD-3-Clause"
 
 inherit goarch
 
-SRC_URI = "https://golang.org/dl/go${PV}.src.tar.gz;name=main"
+SRC_URI = "https://go.dev/dl/go${PV}.src.tar.gz;name=main"
 S = "${WORKDIR}/go"
 B = "${S}"
 UPSTREAM_CHECK_REGEX = "(?P<pver>\d+(\.\d+)+)\.src\.tar"
diff --git a/meta/recipes-devtools/go/go-cross-canadian_1.17.13.bb b/meta/recipes-devtools/go/go-cross-canadian_1.20.10.bb
similarity index 100%
rename from meta/recipes-devtools/go/go-cross-canadian_1.17.13.bb
rename to meta/recipes-devtools/go/go-cross-canadian_1.20.10.bb
diff --git a/meta/recipes-devtools/go/go-cross_1.17.13.bb b/meta/recipes-devtools/go/go-cross_1.20.10.bb
similarity index 100%
rename from meta/recipes-devtools/go/go-cross_1.17.13.bb
rename to meta/recipes-devtools/go/go-cross_1.20.10.bb
diff --git a/meta/recipes-devtools/go/go-crosssdk_1.17.13.bb b/meta/recipes-devtools/go/go-crosssdk_1.20.10.bb
similarity index 100%
rename from meta/recipes-devtools/go/go-crosssdk_1.17.13.bb
rename to meta/recipes-devtools/go/go-crosssdk_1.20.10.bb
diff --git a/meta/recipes-devtools/go/go-native_1.17.13.bb b/meta/recipes-devtools/go/go-native_1.20.10.bb
similarity index 100%
rename from meta/recipes-devtools/go/go-native_1.17.13.bb
rename to meta/recipes-devtools/go/go-native_1.20.10.bb
diff --git a/meta/recipes-devtools/go/go-runtime_1.17.13.bb b/meta/recipes-devtools/go/go-runtime_1.20.10.bb
similarity index 97%
rename from meta/recipes-devtools/go/go-runtime_1.17.13.bb
rename to meta/recipes-devtools/go/go-runtime_1.20.10.bb
index 63464a1501..43b68b4e46 100644
--- a/meta/recipes-devtools/go/go-runtime_1.17.13.bb
+++ b/meta/recipes-devtools/go/go-runtime_1.20.10.bb
@@ -1,3 +1,2 @@
 require go-${PV}.inc
 require go-runtime.inc
-
diff --git a/meta/recipes-devtools/go/go_1.17.13.bb b/meta/recipes-devtools/go/go_1.20.10.bb
similarity index 91%
rename from meta/recipes-devtools/go/go_1.17.13.bb
rename to meta/recipes-devtools/go/go_1.20.10.bb
index bb57c1c48a..deee7d8843 100644
--- a/meta/recipes-devtools/go/go_1.17.13.bb
+++ b/meta/recipes-devtools/go/go_1.20.10.bb
@@ -3,10 +3,10 @@ require go-target.inc
 
 inherit linuxloader
 
-export GOBUILDMODE=""
 export GO_LDSO = "${@get_linuxloader(d)}"
 export CC_FOR_TARGET = "gcc"
 export CXX_FOR_TARGET = "g++"
+export CGO_LDFLAGS:append = " -no-pie"
 
 # mips/rv64 doesn't support -buildmode=pie, so skip the QA checking for mips/riscv32 and its
 # variants.
@@ -14,4 +14,3 @@ python() {
     if 'mips' in d.getVar('TARGET_ARCH') or 'riscv32' in d.getVar('TARGET_ARCH'):
         d.appendVar('INSANE_SKIP:%s' % d.getVar('PN'), " textrel")
 }
-
-- 
2.47.0

